apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: gcpsm-secret-store
spec:
  provider:
    gcpsm:
      # GCP project ID where secrets are stored
      projectId: "konnektr" # Replace with your actual GCP project ID
      auth:
        # Using Workload Identity for authentication
        workloadIdentity:
          clusterLocation: europe-west1 # Replace with your GKE cluster location
          clusterName: konnektr-gke # Replace with your GKE cluster name
          clusterProjectId: "konnektr" # Replace with your GCP project ID
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets
---
# Service Account for external-secrets to access Google Cloud Secret Manager
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets
  annotations:
    # Link to Google Service Account via Workload Identity
    iam.gke.io/gcp-service-account: external-secrets@konnektr-io.iam.gserviceaccount.com # Replace with your GSA
---
# ClusterRoleBinding to allow external-secrets to manage secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets-gcpsm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-secrets-controller
subjects:
  - kind: ServiceAccount
    name: external-secrets-sa
    namespace: external-secrets
